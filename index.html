<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="description"
      content="The web page used the API of @Domeshow created by @Jean-pierre14"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nodejs CRUD with express</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container">
      <div class="row py-3">
        <div class="col-4 col-md-4">
          <div class="card card-body shadow-sm">
            <h3>Registration of course</h3>
            <div id="error"></div>
            <form action="" id="myForm" method="post">
              <div class="form-group">
                <label for="name">Name of course</label>
                <input
                  type="text"
                  name="name"
                  id="name"
                  placeholder="Name of course"
                  class="form-control"
                />
              </div>
              <div class="form-group">
                <label for="desc">Description</label>
                <textarea
                  name="description"
                  id="desc"
                  name="description"
                  class="form-control"
                  placeholder="Description...
                "
                ></textarea>
              </div>
              <div class="form-group mt-3">
                <button type="submit" id="btn_submit" class="btn">
                  Register
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="col-8 col-md-8">
          <div id="results">
            <h4>Loading...</h4>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  const btn = Boolean(false);
  let result = document.getElementById("results");
  const myForm = document.getElementById("myForm"),
    error = document.getElementById("error");

  // Selecting data using Fetch method
  let output = ``;

  let Init = async () => {
    await SelectAll().then(() => {
      getOneCourse();
    });
  };

  const SelectAll = async () => {
    output = "";
    btn = Boolean(true);
    await fetch("http://localhost:7000/api")
      .then((res) => {
        return res.json().then((data) => {
          data.courses.forEach((course) => {
            output += `
              <div class="d-flex shadow-sm my-3 p-3 justify-content-between align-items-center">
                <span>${course.name}</span>
                <div class="btn-group">
                  <button type="button" id="${course._id}" class="edit btn btn-sm btn-info">Edit</button>    
                  <button type="button" id="${course._id}"class="delete btn btn-sm btn-danger">Delete</button>    
                </div>
              </div>
              `;
          });
          result.innerHTML = output;
        });
      })
      .catch((err) => {
        console.log(`Error: ${err.message}`);
        result.innerHTML =
          '<p class="alert alert-danger">You are not connect to the server.</p>';
      });
  };

  // BTN config
  let btnEvent = document.getElementById("btn_submit");

  if (btn) {
    btnEvent.textContent = "Register";
    btnEvent.classList.remove("btn-warning");
    btnEvent.classList.add("btn-primary");
  } else {
    btnEvent.textContent = "Update";
    btnEvent.classList.remove("btn-primary");
    btnEvent.classList.add("btn-warning");
  }

  // Get one course
  const getOneCourse = () => {
    // result.innerHTML = "";
    const get = document.querySelectorAll(".edit").forEach((el) => {
      el.onclick = (event) => {
        const element_ID = event.target.id;
        // console.log("Id: " + element_ID);
        btn = Boolean(false);
        result.innerHTML = '<p class=" alert alert-warning">Loading...</p>';

        fetch(`http://localhost:7000/api/${element_ID}`)
          .then((res) =>
            res.json().then((data) => {
              result.innerHTML = "";
              console.log(data);
              result.innerHTML = `
                <div class="card card-body shadow-sm">
                  <h3 class="nameValue">Name: ${data.courses.name}</h3>
                  <p><strong>Description:</strong> <span class="descValue">${data.courses.description}</span></p>
                  <div class="close">
                    <button class="btn btn-sm btn-info" type="button">Back to the list</button>  
                  </div>
                </div>`;

              const name = document.querySelector("#name"),
                desc = document.querySelector("#desc");

              name.value = data.courses.name;
              desc.value = data.courses.description;
            })
          )
          .catch((err) => {
            console.log("Error: " + err.message);
            // result.innerHTML =
            //   '<p class="alert alert-danger">You are not connect to the server.</p>';
          });
      };
    });
  };

  myForm.onsubmit = (event) => {
    event.preventDefault();

    const formData = new FormData(myForm),
      data = new URLSearchParams(formData);

    // console.log(formData.get("name"));

    // There no validation form here... :)

    fetch("http://localhost:7000/api", {
      method: "POST",
      body: data,
    })
      .then((res) => res.json())
      .then((data) => {
        // console.log(data);
        if (data.status === 200) {
          result.innerHTML = "";
          myForm.reset(0);
          Init();
        } else {
          return;
        }
      })
      .catch((err) => {
        error.innerHTML =
          '<p class="alert alert-danger">You are not connect to the server...</p>';
        console.log(`Error: ${err.message}`);
      });
  };

  Init();
</script>
